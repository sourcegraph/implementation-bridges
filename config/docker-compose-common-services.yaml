services:

  cloud-agent:
    container_name: cloud-agent
    image: index.docker.io/sourcegraph/src-tunnel-agent:latest@sha256:15175b21e778ba8a1372ab7c8de7092b676a1ebd58352891338c3be508f20b52
    volumes:
      - ../config/cloud-agent-service-account-key.json:/sourcegraph/cloud-agent-service-account-key.json:ro
      - ../config/cloud-agent-config.yaml:/sourcegraph/cloud-agent-config.yaml:ro
    command: ["-config=/sourcegraph/cloud-agent-config.yaml"]
    restart: always
    networks:
      - default

  src-serve-git:
    # Uses a valid hostname as container_name, to trick the cloud agent and code host config into finding this container on the Docker network
    container_name: src-serve-git-ubuntu.local
    image:  index.docker.io/sourcegraph/src-cli:latest@sha256:44276c59f31e236ac55b0d005ad0725f5abd73f9cb4f9e2700fad0fff2252ef9
    volumes:
      - ../../../sg/src-serve-root/:/sourcegraph/src-serve-root:ro
    command: "serve-git -addr :443 /sourcegraph/src-serve-root"
    restart: always
    networks:
      - default

networks:
  default:
    ipam:
      driver: default
      config:
        - subnet: "172.20.2.0/27"
